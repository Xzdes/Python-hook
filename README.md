# hook_server.py

Высоконадёжный скрипт для перехвата нажатий клавиш клавиатуры. Гарантирует выдачу событий строго в английской раскладке, вне зависимости от текущего языка пользователя. Идеально подходит для работы со сканерами штрихкодов, кассовыми решениями (POS), автоматизации ввода и создания глобальных горячих клавиш в системах на базе Windows.

## Возможности

*   **Независимость от раскладки:** Всегда возвращает английские символы (`QWERTY`), даже если в системе включена русская (`ЙЦУКЕН`) или любая другая раскладка.
*   **Полный охват клавиш:** Ловит все нажатия, включая спецсимволы, функциональные клавиши (F1-F12) и цифровой блок (NumPad).
*   **Информация о модификаторах:** Каждое событие содержит информацию о том, были ли в момент нажатия зажаты клавиши `Shift`, `Ctrl` или `Alt`.
*   **Обработка состояний:** Корректно учитывает режимы `CapsLock` и `NumLock`.
*   **Стабильность:** Устойчив к принудительному завершению со стороны родительского приложения (например, из Node.js), не вызывает сбоев.
*   **Простая интеграция:** Все события выводятся в виде JSON в `stdout`, что позволяет легко интегрировать его с Node.js, Go, C# и другими языками.

## Требования

*   Python 3.7+
*   Windows (используется WinAPI для получения физических кодов клавиш)
*   Библиотека [pynput](https://pypi.org/project/pynput/)

## Быстрый старт

1.  **Установите зависимости**:
    ```bash
    pip install pynput
    ```

2.  **Запустите скрипт для теста:**
    ```bash
    python hook_server.py
    ```
    Все события от нажатий клавиш будут появляться в консоли в формате JSON.

## Сборка EXE-файла

Для использования в других программах (например, в модуле Node.js) скрипт необходимо скомпилировать в один исполняемый `.exe` файл с помощью PyInstaller.

### Рекомендуемая команда (дружелюбная к антивирусам)

Эта команда является основной и предпочтительной, так как созданный файл с меньшей вероятностью вызовет ложное срабатывание антивируса.

```bash
pyinstaller --onefile --hidden-import=pynput.keyboard._win32 --hidden-import=pynput.keyboard._base hook_server.py
```

*   **Почему это работает?** Эта команда создает "консольное" приложение. С точки зрения антивируса, программа, которая открыто показывает консоль, выглядит менее подозрительно, чем полностью невидимый фоновый процесс.
*   **Примечание:** При запуске такого `.exe` файла может на долю секунды мелькнуть и исчезнуть окно консоли. Это нормальное поведение.

### Альтернативная команда (для "невидимого" режима)

Если вам нужен абсолютно невидимый запуск без мелькания окна, используйте флаг `--noconsole`.

```bash
pyinstaller --onefile --noconsole --hidden-import=pynput.keyboard._win32 --hidden-import=pynput.keyboard._base hook_server.py
```

*   **Внимание!** Именно такое "скрытное" поведение (невидимый процесс перехватывает клавиатуру) часто расценивается антивирусами как вредоносное. Используйте этот способ, только если готовы добавлять `.exe` в исключения антивируса вручную.

## Пример вывода

Скрипт генерирует подробные JSON-события:

**Нажатие клавиши 'a':**
```json
{"type": "key_press", "key": "a", "modifiers": {"shift": false, "ctrl": false, "alt": false}}
```

**Нажатие комбинации Ctrl + Shift + S:**
```json
{"type": "key_press", "key": "S", "modifiers": {"shift": true, "ctrl": true, "alt": false}}
```

**Нажатие Enter:**
```json
{"type": "key_press", "key": "ENTER", "modifiers": {"shift": false, "ctrl": false, "alt": false}}
```

## FAQ

**Q: Будет ли скрипт работать, если в Windows включена русская раскладка?**
**A:** Да. Скрипт всегда выводит символ в английской раскладке по его физическому положению на клавиатуре.

**Q: Антивирус удаляет/блокирует собранный `.exe` файл. Что делать?**
**A:** Это частое ложное срабатывание из-за того, что перехват клавиатуры — типичное поведение для вредоносного ПО. Используйте **рекомендуемую команду сборки** (без `--noconsole`). Если вам абсолютно необходим невидимый режим, добавьте ваш `.exe` в исключения антивируса.

**Q: Можно ли доработать под Linux/macOS?**
**A:** В текущей реализации используется WinAPI, поэтому скрипт работает только под Windows. Для кросс-платформенной поддержки потребуется переписать логику получения состояния клавиш под каждую ОС.
